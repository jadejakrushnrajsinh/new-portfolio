<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Portfolio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }

        .messages-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .section-header {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
        }

        .message-list {
            list-style: none;
        }

        .message-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .message-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .message-date {
            color: #666;
            font-size: 0.9rem;
        }

        .message-email {
            color: #3498db;
            margin-bottom: 5px;
        }

        .message-subject {
            font-weight: 500;
            margin-bottom: 10px;
        }

        .message-text {
            color: #555;
            line-height: 1.5;
        }

        .message-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .message-item {
                flex-direction: column;
            }

            .message-actions {
                flex-direction: row;
                justify-content: flex-end;
                margin-top: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
        <p>Manage portfolio contact messages</p>
    </div>

    <div class="container">
        <div id="login-section">
            <div class="messages-section">
                <div class="section-header">
                    <i class="fas fa-lock"></i> Admin Login
                </div>
                <div style="padding: 20px;">
                    <div class="error" id="login-error" style="display: none;"></div>
                    <form id="login-form">
                        <div style="margin-bottom: 15px;">
                            <label for="email"
                                style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                            <input type="email" id="email" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="password"
                                style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
                            <input type="password" id="password" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
                        </div>
                        <button type="submit" class="btn"
                            style="background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%;">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="dashboard-section" style="display: none;">
            <div class="error" id="error" style="display: none;"></div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-messages">0</div>
                    <div>Total Messages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unread-messages">0</div>
                    <div>Unread Messages</div>
                </div>
            </div>

            <div class="messages-section">
                <div class="section-header">
                    <i class="fas fa-envelope"></i> Contact Messages
                </div>
                <div class="loading" id="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading messages...
                </div>
                <ul class="message-list" id="message-list"></ul>
            </div>

            <div class="projects-section" style="margin-top: 30px;">
                <div class="section-header">
                    <i class="fas fa-project-diagram"></i> Projects Management
                    <button onclick="showAddProjectForm()"
                        style="float: right; background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Add
                        Project</button>
                </div>
                <div id="project-form"
                    style="display: none; padding: 20px; background: #f9f9f9; border-radius: 5px; margin-bottom: 20px;">
                    <h3 id="form-title">Add New Project</h3>
                    <form id="add-project-form">
                        <input type="hidden" id="project-id">
                        <div style="margin-bottom: 10px;">
                            <label>Title:</label>
                            <input type="text" id="project-title" required
                                style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>Description:</label>
                            <textarea id="project-description" required
                                style="width: 100%; padding: 8px; margin-top: 5px; height: 80px;"></textarea>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>Image URL:</label>
                            <input type="url" id="project-image" required
                                style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>Technologies (comma separated):</label>
                            <input type="text" id="project-tech" placeholder="HTML, CSS, JavaScript"
                                style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>Live Demo URL:</label>
                            <input type="url" id="project-live" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label>GitHub URL:</label>
                            <input type="url" id="project-github" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <button type="submit" class="btn"
                            style="background: #3498db; color: white; margin-right: 10px;">Save</button>
                        <button type="button" onclick="hideProjectForm()" class="btn"
                            style="background: #95a5a6; color: white;">Cancel</button>
                    </form>
                </div>
                <div class="loading" id="projects-loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading projects...
                </div>
                <ul class="message-list" id="project-list"></ul>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="logout()" class="btn" style="background: #e74c3c; color: white;">Logout</button>
            </div>
        </div>
    </div>

    <script>
        function getAuthHeaders() {
            const token = localStorage.getItem('adminToken');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Check if already logged in
            if (localStorage.getItem('adminToken')) {
                showDashboard();
            } else {
                showLogin();
            }

            // Handle login form
            document.getElementById('login-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const error = document.getElementById('login-error');

                try {
                    const response = await fetch('/api/admin/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        localStorage.setItem('adminToken', data.token);
                        showDashboard();
                    } else {
                        error.textContent = data.error || 'Login failed';
                        error.style.display = 'block';
                    }
                } catch (err) {
                    console.error('Login error:', err);
                    error.textContent = 'An error occurred during login';
                    error.style.display = 'block';
                }
            });
        });

        function showLogin() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('dashboard-section').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            loadMessages();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            showLogin();
        }

        async function loadMessages() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const messageList = document.getElementById('message-list');

            loading.style.display = 'block';
            error.style.display = 'none';

            try {
                const response = await fetch('/api/contact', {
                    headers: getAuthHeaders()
                });
                const messages = await response.json();

                if (response.ok) {
                    displayMessages(messages);
                    updateStats(messages);
                } else {
                    throw new Error('Failed to load messages');
                }
            } catch (err) {
                console.error('Error loading messages:', err);
                error.textContent = 'Failed to load messages. Please try again.';
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayMessages(messages) {
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';

            if (messages.length === 0) {
                messageList.innerHTML = '<li class="message-item"><div class="message-content"><p>No messages yet.</p></div></li>';
                return;
            }

            messages.forEach(message => {
                const messageItem = document.createElement('li');
                messageItem.className = 'message-item';
                messageItem.innerHTML = `
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-name">${escapeHtml(message.name)}</span>
                            <span class="message-date">${formatDate(message.createdAt)}</span>
                        </div>
                        <div class="message-email">${escapeHtml(message.email)}</div>
                        <div class="message-subject">${escapeHtml(message.subject)}</div>
                        <div class="message-text">${escapeHtml(message.message)}</div>
                    </div>
                    <div class="message-actions">
                        <button class="btn btn-delete" onclick="deleteMessage('${message._id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                messageList.appendChild(messageItem);
            });
        }

        function updateStats(messages) {
            document.getElementById('total-messages').textContent = messages.length;
            // For simplicity, assume all are unread
            document.getElementById('unread-messages').textContent = messages.length;
        }

        async function deleteMessage(id) {
            if (!confirm('Are you sure you want to delete this message?')) return;

            try {
                const response = await fetch(`/api/contact/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    loadMessages(); // Reload messages
                } else {
                    alert('Failed to delete message');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('An error occurred while deleting the message');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Projects management
        function showAddProjectForm() {
            document.getElementById('form-title').textContent = 'Add New Project';
            document.getElementById('project-id').value = '';
            document.getElementById('add-project-form').reset();
            document.getElementById('project-form').style.display = 'block';
        }

        function hideProjectForm() {
            document.getElementById('project-form').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            loadMessages();
            loadProjects();
        }

        async function loadProjects() {
            const loading = document.getElementById('projects-loading');
            const projectList = document.getElementById('project-list');

            loading.style.display = 'block';

            try {
                const response = await fetch('/api/projects', {
                    headers: getAuthHeaders()
                });
                const projects = await response.json();

                if (response.ok) {
                    displayProjects(projects);
                } else {
                    throw new Error('Failed to load projects');
                }
            } catch (err) {
                console.error('Error loading projects:', err);
                projectList.innerHTML = '<li class="message-item"><div class="message-content"><p>Failed to load projects.</p></div></li>';
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayProjects(projects) {
            const projectList = document.getElementById('project-list');
            projectList.innerHTML = '';

            if (projects.length === 0) {
                projectList.innerHTML = '<li class="message-item"><div class="message-content"><p>No projects yet.</p></div></li>';
                return;
            }

            projects.forEach(project => {
                const projectItem = document.createElement('li');
                projectItem.className = 'message-item';
                projectItem.innerHTML = `
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-name">${escapeHtml(project.title)}</span>
                            <span class="message-date">${formatDate(project.createdAt)}</span>
                        </div>
                        <div class="message-text">${escapeHtml(project.description)}</div>
                        <div style="margin-top: 10px;">
                            <strong>Tech:</strong> ${project.tech ? project.tech.join(', ') : 'N/A'}
                        </div>
                        <div style="margin-top: 5px;">
                            <a href="${project.liveDemo || '#'}" target="_blank">Live Demo</a> |
                            <a href="${project.github || '#'}" target="_blank">GitHub</a>
                        </div>
                    </div>
                    <div class="message-actions">
                        <button class="btn" style="background: #f39c12; color: white; margin-bottom: 5px;" onclick="editProject('${project._id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-delete" onclick="deleteProject('${project._id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                projectList.appendChild(projectItem);
            });
        }

        document.getElementById('add-project-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const id = document.getElementById('project-id').value;
            const title = document.getElementById('project-title').value;
            const description = document.getElementById('project-description').value;
            const image = document.getElementById('project-image').value;
            const tech = document.getElementById('project-tech').value.split(',').map(t => t.trim()).filter(t => t);
            const liveDemo = document.getElementById('project-live').value;
            const github = document.getElementById('project-github').value;

            const projectData = { title, description, image, tech, liveDemo, github };

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/api/projects/${id}` : '/api/projects';

                const response = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(projectData)
                });

                if (response.ok) {
                    hideProjectForm();
                    loadProjects();
                    if (!id) {
                        alert('Project added successfully!');
                    } else {
                        alert('Project updated successfully!');
                    }
                } else {
                    alert('Failed to save project');
                }
            } catch (error) {
                console.error('Error saving project:', error);
                alert('An error occurred while saving the project');
            }
        });

        function editProject(id) {
            fetch(`/api/projects`, {
                headers: getAuthHeaders()
            })
                .then(response => response.json())
                .then(projects => {
                    const project = projects.find(p => p._id === id);
                    if (project) {
                        document.getElementById('form-title').textContent = 'Edit Project';
                        document.getElementById('project-id').value = project._id;
                        document.getElementById('project-title').value = project.title;
                        document.getElementById('project-description').value = project.description;
                        document.getElementById('project-image').value = project.image;
                        document.getElementById('project-tech').value = project.tech ? project.tech.join(', ') : '';
                        document.getElementById('project-live').value = project.liveDemo || '';
                        document.getElementById('project-github').value = project.github || '';
                        document.getElementById('project-form').style.display = 'block';
                    }
                })
                .catch(error => console.error('Error loading project for edit:', error));
        }

        async function deleteProject(id) {
            if (!confirm('Are you sure you want to delete this project?')) return;

            try {
                const response = await fetch(`/api/projects/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    loadProjects();
                } else {
                    alert('Failed to delete project');
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('An error occurred while deleting the project');
            }
        }
    </script>
</body>

</html>